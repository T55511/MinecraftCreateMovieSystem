version: '3.8'

services:
  # --- 1. FastAPI ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ ---
  api:
    build: .  # ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®Dockerfileã‚’ä½¿ç”¨
    container_name: coding-partner-api
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    volumes:
      - .:/app  # ãƒ›ã‚¹ãƒˆã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ³ãƒ†ãƒŠã«ãƒã‚¦ãƒ³ãƒˆ (é–‹ç™ºç”¨)
    ports:
      - "8010:8000"
    environment:
      - FRONTEND_URL=http://localhost:3010  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®URL
    env_file:
      - .env  # ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®š
    depends_on:
      - db
    restart: always

  # --- 2. PostgreSQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µãƒ¼ãƒ“ã‚¹ ---
  db:
    image: postgres:15-alpine
    container_name: minecraft_movie_db
    volumes:
      - postgres_data:/var/lib/postgresql/data/
      - ./init-db:/docker-entrypoint-initdb.d  # åˆæœŸSQLã‚’å®Ÿè¡Œ
    env_file:
      - .env
    ports:
      - "5410:5432"
    restart: always
    healthcheck: # DBã®èµ·å‹•ç¢ºèª
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 5s
      retries: 5

  # --- 3. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ ã‚µãƒ¼ãƒ“ã‚¹ (ã“ã“ã§ã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã¨ã—ã¦å®šç¾©) ---
  frontend:
    image: node:18-alpine
    container_name: coding-partner-frontend
    # command: sh -c "echo 'Frontend setup complete' && sleep infinity" # ä»®ã®ã‚³ãƒãƒ³ãƒ‰
    build:
      context: ./frontend
    volumes:
      - ./frontend:/app
      - /app/node_modules
    ports:
      - "3010:3000"
    tty: true  # ğŸ‘ˆ ã“ã‚Œã‚’è¿½åŠ 
    stdin_open: true # ğŸ‘ˆ ã“ã‚Œã‚’è¿½åŠ 
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8010 # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIã®URL
      - CHOKIDAR_USEPOLLING=true # ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ç”¨
    command: sh -c "npm install && npm run dev -- -p 3000 -H 0.0.0.0"
    depends_on:
      - api
    restart: always

volumes:
  postgres_data: